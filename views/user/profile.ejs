<%- include('../partials/user/header.ejs') %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        /* Modern Profile Page Styling */
        .profile-container {
            background-color: #f8f9fa;
            min-height: 100vh;
            padding: 2rem 0;
        }

        .sidebar {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            height: fit-content;
        }

        .user-info {
            padding: 1rem;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 1rem;
        }

        .user-info .user-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2874f0;
        }

        .nav-pills .nav-link {
            color: #4a4a4a;
            padding: 0.8rem 1rem;
            margin: 0.2rem 0;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-pills .nav-link:hover {
            background-color: #f5f7fa;
        }

        .nav-pills .nav-link.active {
            background-color: #2874f0;
            color: white;
        }

        .content-area {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            min-height: 500px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2874f0;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        /* Order Card Styling */
        .order-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .order-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .order-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.875rem;
        }

        .status-delivered {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-pending {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* Form Styling */
        .form-control {
            border-radius: 5px;
            border: 1px solid #ddd;
            padding: 0.75rem;
        }

        .form-control:focus {
            border-color: #2874f0;
            box-shadow: 0 0 0 0.2rem rgba(40, 116, 240, 0.25);
        }

        .btn-primary {
            background-color: #2874f0;
            border-color: #2874f0;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
        }

        .btn-primary:hover {
            background-color: #1c5ac4;
            border-color: #1c5ac4;
        }

        .eye-icon {
            position: absolute;
            right: 10px;
            top: 70%;
            transform: translateY(-50%);
            cursor: pointer;
        }

        .position-relative {
            position: relative;
        }
       

.product-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
}
    </style>
    <div class="section">
        <div class="profile-container">
            <div class="container">
                <div class="row g-4">
                    <!-- Sidebar -->
                    <div class="col-md-3">
                        <div class="sidebar">
                            <div class="user-info">
                                <div class="text-muted">Welcome,</div>
                                <div class="user-name">
                                    <%= user.name %>
                                </div>
                                <small>Your referral code: <%= referralCode %></small>
                            </div>
                            <div class="nav nav-pills flex-column">
                                <a class="nav-link active" data-bs-toggle="pill" href="#profile">Profile Information</a>
                                <a class="nav-link" data-bs-toggle="pill" href="#addresses">Manage Addresses</a>
                                <a class="nav-link" data-bs-toggle="pill" href="#orders">My Orders</a>
                               
                                <a class="nav-link text-danger" href="/logout" id="logoutLink">Logout</a>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="col-md-9">
                        <div class="content-area">
                            <div class="tab-content">
                                <!-- Profile Section -->
                                <div class="tab-pane fade show active mb-5 pb-5" id="profile">

                                    <div class="section-title">Personal Information</div>
                                    <div id="profileInfo">
                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <p class="text-muted mb-1">Name</p>
                                                <p class="fw-bold">
                                                    <%= user.name %>
                                                </p>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="text-muted mb-1">Email</p>
                                                <p class="fw-bold">
                                                    <%= user.email %>
                                                </p>
                                            </div>
                                        </div>
                                        <button onclick="toggleProfileEdit()" class="btn btn-primary">Edit
                                            Profile</button>
                                    </div>
                                    <!-- Profile Edit Form -->
                                    <div id="profileEditForm" style="display: none;">
                                        <form id="editProfileForm" class="mt-3">
                                            <div class="mb-3">
                                                <label for="editName" class="form-label">Name</label>
                                                <input type="text" class="form-control" id="editName" name="name"
                                                    pattern="[A-Za-z\s]{2,}" title="Name should contain only letters">
                                                <div id="nameError" class="invalid-feedback" style="color:red;"></div>

                                            </div>
                                            <div class="mb-3">
                                                <label for="editEmail" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="editEmail" name="email">
                                                <div id="emailError" class="invalid-feedback" style="color:red;"></div>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Save Changes</button>
                                            <button type="button" class="btn btn-secondary"
                                                onclick="toggleProfileEdit()">Cancel</button>
                                        </form>

                                    </div>
                                    <!-------------------------- Change Password Section -------------------------->
                                    <div class="mt-5">
                                        <div class="section-title">Change Password</div>
                                        <button id="showChangePasswordForm" class="btn btn-primary mb-3">Change
                                            Password</button>
                                        <form id="changePasswordForm" class="mt-3" style="display: none;">
                                            <div class="mb-3 position-relative">
                                                <label for="currentPassword" class="form-label">Current Password</label>
                                                <input type="password" class="form-control" id="currentPassword"
                                                    name="currentPassword">
                                                <i class="eye-icon fas fa-eye-slash"
                                                    onclick="togglePasswordVisibility('currentPassword')"></i>
                                                <div id="currentPasswordError" class="invalid-feedback"
                                                    style="color:red;">
                                                </div>

                                            </div>
                                            <div class="mb-3 position-relative">
                                                <label for="newPassword" class="form-label">New Password</label>
                                                <input type="password" class="form-control" id="newPassword"
                                                    name="newPassword">
                                                <i class="eye-icon fas fa-eye-slash"
                                                    onclick="togglePasswordVisibility('newPassword')"></i>
                                                <div id="newPasswordError" class="invalid-feedback" style="color:red;">
                                                </div>
                                            </div>
                                            <div class="mb-3 position-relative">
                                                <label for="confirmNewPassword" class="form-label">Confirm New
                                                    Password</label>
                                                <input type="password" class="form-control" id="confirmNewPassword"
                                                    name="confirmNewPassword">
                                                <i class="eye-icon fas fa-eye-slash"
                                                    onclick="togglePasswordVisibility('confirmNewPassword')"></i>
                                                <div id="confirmPasswordError" class="invalid-feedback"
                                                    style="color:red;">
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Save New Password</button>
                                            <button type="button" class="btn btn-secondary"
                                                id="cancelChangePassword">Cancel</button>
                                        </form>
                                    </div>

                                </div>

                                <!------------------------- Orders Section ------------------------->
                                <div class="tab-pane fade" id="orders">
                                    <div class="section-title">My Orders</div>
                                    <div id="ordersContainer">
                                        <% if (typeof orders !=='undefined' && orders && orders.length> 0) { %>
                                            <% orders.forEach(order=> { %>
                                                <div class="order-card">
                                                    <div class="order-header">
                                                        <div>
                                                            <h6 class="mb-0">Order #<%= order.orderId %>
                                                            </h6>
                                                            <small class="text-muted">Ordered on <%= new
                                                                    Date(order.createdOn).toLocaleDateString() %>
                                                            </small>
                                                        </div>
                                                        <span
                                                            class="order-status <%= order.status.toLowerCase() === 'delivered' ? 'status-delivered' : 'status-pending' %>">
                                                            <%= order.status %>
                                                        </span>
                                                    </div>
                                                    <!--ordered items section-->
                                                    <% if (order.orderedItems && order.orderedItems.length> 0) { %>
                                                        <% order.orderedItems.forEach(item=> { %>
                                                            <div class="row align-items-center mt-3">
                                                                <div class="col-2">
                                                                    <% if (item.product && item.product.productImage &&
                                                                        item.product.productImage[0]) { %>
                                                                        <img src="/uploads/re-image/<%= item.product.productImage[0] %>"
                                                                            class="product-image"
                                                                            alt="<%= item.product.productName %>">
                                                                        <% } else { %>
                                                                            <div
                                                                                class="product-image bg-light d-flex align-items-center justify-content-center">
                                                                                <span class="text-muted">No Image</span>
                                                                            </div>
                                                                            <% } %>
                                                                </div>
                                                                <div class="col-7">
                                                                    <h6 class="mb-1">
                                                                        <%= item.product ? item.product.productName
                                                                            : 'Product Name Not Available' %>
                                                                    </h6>
                                                                    <p class="mb-0 text-muted">Quantity: <%=
                                                                            item.quantity || 0 %>
                                                                    </p>
                                                                </div>
                                                                <div class="col-3 text-end">
                                                                    <h6 class="mb-0">₹<%= (item.quantity * item.price ||
                                                                            0).toFixed(2) %>
                                                                    </h6>
                                                                </div>
                                                            </div>
                                                            <% }); %>
                                                                <% } %>
                                                                    <!-- View/Track Order Link -->
                                                                    <div class="mt-3 text-end">
                                                                        <a href="/track-order/<%= order.orderId %>"
                                                                            class="btn btn-outline-primary btn-sm">View
                                                                            Order</a>
                                                                    </div>

                                                </div>
                                                <% }); %>
                                                    <% } else { %>
                                                        <div class="text-center py-5">
                                                            <div class="mb-3">
                                                                <i class="fas fa-shopping-bag fa-3x text-muted"></i>
                                                            </div>
                                                            <h5 class="text-muted">No orders found</h5>
                                                            <p class="text-muted mb-3">Looks like you haven't made any
                                                                orders yet.</p>
                                                            <a href="/products" class="btn btn-primary">Start
                                                                Shopping</a>
                                                        </div>
                                                        <% } %>
                                    </div>
                                </div>
<!-----------------------------------------------order section ends--------------------------------------->


                                <!-------------------------------------------- Address Management Section ---------------------------------------------------->

                                <div id="addresses" class="tab-pane fade">
                                    <div class="section-title d-flex justify-content-between align-items-center">
                                        <div class="section-title">Addresses</div>
                                        <button class="btn btn-primary btn-sm" id="addAddressBtn"
                                            onclick="toggleAddForm()">+
                                            Add New Address</button>
                                    </div>

                                    <% if (locals.error) { %>
                                        <div class="alert alert-danger" role="alert">
                                            <%= error %>
                                        </div>
                                        <% } %>

                                            <% if (locals.success) { %>
                                                <div class="alert alert-success" role="alert">
                                                    <%= success %>
                                                </div>
                                                <% } %>

                                                    <!----------------------------- Add address form (initially hidden) -------------------->
                                                    <div id="addAddressForm" class="add-address-form card mb-3"
                                                        style="max-width: 700px; display:none; font: size 14px;">
                                                        <div class="card-body">
                                                            <form id="addressForm">

                                                                <div class="row mb-3">
                                                                    <div class="col-6">
                                                                        <input type="text" name="name"
                                                                            class="form-control"
                                                                            pattern="[A-Za-z\s]{2,}"
                                                                            title="Name should contain only letters"
                                                                            placeholder="Name">
                                                                        <div class="invalid-feedback">Please enter the
                                                                            house
                                                                            name.</div>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <input type="text" name="phone"
                                                                            class="form-control"
                                                                            placeholder="10-digit mobile number"
                                                                            pattern="\d{10}">
                                                                        <div class="invalid-feedback">Please enter a
                                                                            valid
                                                                            10-digit mobile
                                                                            number.</div>
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <div class="col-6">
                                                                        <input type="text" name="pincode"
                                                                            class="form-control" placeholder="Pincode"
                                                                            pattern="\d{6}">
                                                                        <div class="invalid-feedback">Please enter a
                                                                            valid
                                                                            6-digit pincode.</div>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <input type="text" name="city"
                                                                            class="form-control"
                                                                            pattern="[A-Za-z\s]{2,}"
                                                                            placeholder="City/Town">
                                                                        <div class="invalid-feedback">Please enter the
                                                                            city/town.</div>
                                                                    </div>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <input type="text" name="landMark"
                                                                        class="form-control" placeholder="Landmark">
                                                                    <div class="invalid-feedback">Please enter a
                                                                        landmark.
                                                                    </div>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <input type="text" name="district"
                                                                        class="form-control" pattern="[A-Za-z\s]{2,}"
                                                                        placeholder="District">
                                                                    <div class="invalid-feedback">Please enter your
                                                                        district.
                                                                    </div>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <select name="state" id="state" class="form-select">

                                                                        <option value="" selected disabled>--Select
                                                                            State--
                                                                        </option>
                                                                        <option value="Andaman and Nicobar Islands">
                                                                            Andaman
                                                                            and
                                                                            Nicobar Islands
                                                                        </option>

                                                                        <option value="Kerala">Kerala</option>
                                                                        <option value="Ladakh">Ladakh</option>

                                                                    </select>
                                                                    <div class="invalid-feedback">Please select a state.
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <div class="col-6">
                                                                        <input type="text" name="altPhone"
                                                                            pattern="\d{10}" class="form-control"
                                                                            placeholder="Alternate Phone (Optional)">
                                                                        <div class="invalid-feedback">Please enter a
                                                                            valid
                                                                            alternate phone number.
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <label for="addressType">Address Type</label>
                                                                        <select name="addressType" class="form-select">
                                                                            <option value="Home">Home</option>
                                                                            <option value="Work">Work</option>
                                                                        </select>
                                                                        <div class="invalid-feedback">Please select an
                                                                            address
                                                                            type.</div>
                                                                    </div>
                                                                </div>

                                                                <div class="d-flex justify-content-between">
                                                                    <button type="submit" id="saveAddressButton"
                                                                        class="btn btn-primary">Save
                                                                        Address</button>
                                                                    <button type="reset" class="btn btn-secondary"
                                                                        onclick="toggleAddForm()">Cancel</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>

                                                    <!--------------------------------- List of saved addresses ------------------------------------>
                                                    <div class="saved-addresses" id="addressList">

                                                        <% if(typeof addresses !=='undefined' && addresses.length> 0) {
                                                            %>
                                                            <% addresses.forEach((addr,index)=> { %>
                                                                <% addr.address.forEach((addressItem)=> { %>
                                                                    <div class="address-box"
                                                                        id="address-<%= addressItem._id %>">
                                                                        <div
                                                                            class="d-flex justify-content-between mb-2">
                                                                            <span class="fw-bold">
                                                                                <%= addressItem.addressType %>
                                                                            </span>
                                                                            <div>
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-primary me-2"
                                                                                    onclick="toggleEditForm('<%= addressItem._id %>')">Edit</button>
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    onclick="deleteAddress('<%= addressItem._id %>')">Delete</button>
                                                                            </div>
                                                                        </div>
                                                                        <div>
                                                                            <%= addressItem.name || 'No Name' %>
                                                                        </div>
                                                                        <div>
                                                                            <%= addressItem.city %>, <%=
                                                                                    addressItem.landMark %>
                                                                                    , <%= addressItem.district %>
                                                                        </div>
                                                                        <div>
                                                                            <%= addressItem.state %>, <%=
                                                                                    addressItem.pincode %>
                                                                        </div>
                                                                        <div>Phone: <%= addressItem.phone %><br>
                                                                                Alt Phone: <%= addressItem.altPhone %>
                                                                        </div>

                                                                        <!--------------------------------- Hidden Edit Form ------------------------------------>
                                                                        <div id="editForm-<%= addressItem._id %>"
                                                                            class="edit-form mt-2 card mb-3"
                                                                            style="max-width: 700px; display:none; font: size 14px;">
                                                                            <div class="card-body">
                                                                                <form
                                                                                    onsubmit="submitEditForm('<%= addressItem._id %>', event)">
                                                                                    <div class=" row mb-3">
                                                                                        <div class="col-6">
                                                                                            <input type="text"
                                                                                                name="name"
                                                                                                class="form-control"
                                                                                                pattern="[A-Za-z\s]{2,}"
                                                                                                title="Name should contain only letters"
                                                                                                value="<%= addressItem.name %>">
                                                                                            <div
                                                                                                class="invalid-feedback">
                                                                                                Please
                                                                                                enter the house name.
                                                                                            </div>
                                                                                        </div>

                                                                                        <div class="col-6">
                                                                                            <input type="text"
                                                                                                name="phone"
                                                                                                class="form-control"
                                                                                                pattern="\d{10}"
                                                                                                value="<%= addressItem.phone %>">
                                                                                            <div
                                                                                                class="invalid-feedback">
                                                                                                Please
                                                                                                enter a valid 10-digit
                                                                                                mobile
                                                                                                number.</div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class=" row mb-3">
                                                                                        <div class="col-6">
                                                                                            <input type="text"
                                                                                                name="pincode"
                                                                                                class="form-control"
                                                                                                pattern="\d{6}"
                                                                                                value="<%= addressItem.pincode %>">
                                                                                            <div
                                                                                                class="invalid-feedback">
                                                                                                Please
                                                                                                enter a valid 6-digit
                                                                                                pincode.
                                                                                            </div>
                                                                                        </div>

                                                                                        <div class="col-6">
                                                                                            <input type="text"
                                                                                                name="city"
                                                                                                class="form-control"
                                                                                                pattern="[A-Za-z\s]{2,}"
                                                                                                value="<%= addressItem.city %>">
                                                                                            <div
                                                                                                class="invalid-feedback">
                                                                                                Please
                                                                                                enter
                                                                                                the city/town.</div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class=" mb-3">
                                                                                        <input type="text"
                                                                                            name="landMark"
                                                                                            class="form-control"
                                                                                            value="<%= addressItem.landMark %>">
                                                                                        <div class="invalid-feedback">
                                                                                            Please
                                                                                            enter a
                                                                                            landmark.</div>
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <input type="text"
                                                                                            name="district"
                                                                                            class="form-control"
                                                                                            value="<%= addressItem.district %>">
                                                                                        <div class="invalid-feedback">
                                                                                            Please
                                                                                            enter
                                                                                            your district.</div>
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <select name="state" id="state"
                                                                                            class="form-select">

                                                                                            <option value="" selected
                                                                                                disabled>
                                                                                                --<%= addressItem.state
                                                                                                    %>--
                                                                                            </option>
                                                                                            <option
                                                                                                value="Andaman and Nicobar Islands">
                                                                                                Andaman and Nicobar
                                                                                                Islands
                                                                                            </option>

                                                                                            <option value="Kerala">
                                                                                                Kerala
                                                                                            </option>
                                                                                            <option value="Ladakh">
                                                                                                Ladakh
                                                                                            </option>

                                                                                        </select>
                                                                                        <!--<input type="text" name="state" class="form-control" value="<%= addressItem.state %>" >-->
                                                                                        <div class="invalid-feedback">
                                                                                            Please
                                                                                            select
                                                                                            a state.</div>
                                                                                    </div>
                                                                                    <div class="row mb-3">
                                                                                        <div class="col-6">
                                                                                            <input type="text"
                                                                                                name="altPhone"
                                                                                                pattern="\d{10}"
                                                                                                class="form-control"
                                                                                                placeholder="Alternate Phone (Optional)">
                                                                                            <div
                                                                                                class="invalid-feedback">
                                                                                                Please
                                                                                                enter a valid alternate
                                                                                                phone
                                                                                                number.
                                                                                            </div>
                                                                                        </div>
                                                                                        <div class="col-6">
                                                                                            <select name="addressType"
                                                                                                class="form-select">
                                                                                                <option value="Home"
                                                                                                    <%=addressItem.addressType==='Home'
                                                                                                    ? 'selected' : '' %>
                                                                                                    >Home
                                                                                                </option>
                                                                                                <option value="Work"
                                                                                                    <%=addressItem.addressType==='Work'
                                                                                                    ? 'selected' : '' %>
                                                                                                    >Work
                                                                                                </option>
                                                                                            </select>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="d-flex justify-content-between mt-3">
                                                                                        <button type="submit"
                                                                                            class="btn btn-primary btn-sm mb-2">Save
                                                                                            Changes</button>
                                                                                        <button type="button"
                                                                                            class="btn btn-secondary btn-sm"
                                                                                            onclick="toggleEditForm('<%= addressItem._id %>')">Cancel</button>
                                                                                    </div>
                                                                                </form>
                                                                            </div>
                                                                        </div>
                                                                        <hr>
                                                                    </div>
                                                                    <% }) %>
                                                                        <% }) %>
                                                                            <% } else { %>
                                                                                <p>No addresses found.</p>
                                                                                <% } %>
                                                    </div>
                                </div>



                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Bootstrap tabs
            const triggerTabList = [].slice.call(document.querySelectorAll('.nav-link'));
            triggerTabList.forEach(function (triggerEl) {
                triggerEl.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (this.getAttribute('href') === '/logout') return;

                    // Remove active class from all tabs and content
                    triggerTabList.forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(el => {
                        el.classList.remove('show', 'active');
                    });

                    // Activate clicked tab and content
                    this.classList.add('active');
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.classList.add('show', 'active');
                    }
                });
            });

            // Debug logging for orders
            console.log('Checking orders container...');
            const ordersContainer = document.getElementById('ordersContainer');
            if (ordersContainer) {
                console.log('Orders container found');
                console.log('Orders container content:', ordersContainer.innerHTML);
            } else {
                console.error('Orders container not found');
            }
        })
        // Profile edit functionality
        function toggleProfileEdit() {
            const infoElement = document.getElementById('profileInfo');
            const formElement = document.getElementById('profileEditForm');

            if (infoElement.style.display !== 'none') {
                infoElement.style.display = 'none';
                formElement.style.display = 'block';
                populateProfileForm();
            } else {
                infoElement.style.display = 'block';
                formElement.style.display = 'none';
            }
        }


        function populateProfileForm() {
            const nameInput = document.getElementById('editName');
            const emailInput = document.getElementById('editEmail');
            if (nameInput && emailInput) {
                nameInput.value = '<%= user.name %>';
                emailInput.value = '<%= user.email %>';
            }
        }

        document.getElementById('editProfileForm').addEventListener('submit', function (e) {
            e.preventDefault();
            let isValid = true;

            // Name validation
            const name = document.getElementById('editName').value;
            const nameError = document.getElementById('nameError');
            const namePattern = /^[A-Za-z\s]{2,}$/;

            if (!namePattern.test(name)) {  // Fix this line
                nameError.textContent = "Please enter a valid name (only letters and at least 2 characters).";
                nameError.style.display = 'block';  // Display the error message
                isValid = false;
            } else {
                nameError.textContent = "";
                nameError.style.display = 'none';  // Hide the error message when valid
            }

            // Email validation
            const email = document.getElementById('editEmail').value;
            const emailError = document.getElementById('emailError');
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Simplified email regex

            if (!emailPattern.test(email)) {
                emailError.textContent = "Please enter a valid email address.";
                emailError.style.display = 'block';  // Display the error message
                isValid = false;
            } else {
                emailError.textContent = "";
                emailError.style.display = 'none';  // Hide the error message when valid
            }

            // Check form validity before proceeding
            if (!isValid) {
                return;  // Do not proceed if form is invalid
            }

            // Send AJAX request to update profile
            fetch('/updateProfile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, email }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update displayed info
                        document.querySelector('#profileInfo p:first-child').textContent = `Name: ${name}`;
                        document.querySelector('#profileInfo p:nth-child(2)').textContent = `Email: ${email}`;
                        toggleProfileEdit(); // Hide the form

                        Swal.fire({
                            title: 'Profile updated successfully',
                            icon: 'success',
                            confirmButtonText: 'OK',

                        })
                    } else {

                        console.error(data.error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Failed to update profile' || data.error,
                            icon: 'error',
                            confirmButtonText: 'OK',

                        })
                    }
                })
                .catch(error => {
                    console.error('Error:', error);

                    Swal.fire({
                        title: 'Error',
                        text: 'An error occurred while updating the profile',
                        icon: 'error',
                        confirmButtonText: 'OK'

                    })
                });
        });

        //  change password functionality
        document.getElementById('showChangePasswordForm').addEventListener('click', function () {
            document.getElementById('changePasswordForm').style.display = 'block';
            this.style.display = 'none';
        });

        document.getElementById('cancelChangePassword').addEventListener('click', function () {
            document.getElementById('changePasswordForm').style.display = 'none';
            document.getElementById('showChangePasswordForm').style.display = 'block';
            document.getElementById('changePasswordForm').reset();
        });



        document.getElementById('changePasswordForm').addEventListener('submit', function (e) {
            e.preventDefault();
            let isValid = true

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            const currentPasswordError = document.getElementById('currentPasswordError')
            const confirmPasswordError = document.getElementById('confirmPasswordError')
            const newPasswordError = document.getElementById('newPasswordError')

            passwordPattern = /^.{6}$/

            // Reset error messages
            currentPasswordError.textContent = '';
            currentPasswordError.style.display = 'none';

            newPasswordError.textContent = '';
            newPasswordError.style.display = 'none';

            confirmPasswordError.textContent = '';
            confirmPasswordError.style.display = 'none';


            if (!currentPassword) {
                currentPasswordError.textContent = 'This  field is required'
                currentPasswordError.style.display = 'block'
                isValid = false
            } else {
                currentPasswordError.textContent = '';
                currentPasswordError.style.display = 'none'

            }
            if (!newPassword) {
                newPasswordError.textContent = 'This  field is required'
                newPasswordError.style.display = 'block'
                isValid = false;
            } else if (!passwordPattern.test(newPassword)) {
                newPasswordError.textContent = 'Password must be at least 6 characters long';
                newPasswordError.style.display = 'block';
                isValid = false;
            } else {
                newPasswordError.textContent = '';
                newPasswordError.style.display = 'none';
            }
            if (!confirmNewPassword) {
                confirmPasswordError.textContent = 'This  field is required'
                confirmPasswordError.style.display = 'block'
                isValid = false;
            } else if (newPassword !== confirmNewPassword) {
                confirmPasswordError.textContent = 'Passwords do not match';
                confirmPasswordError.style.display = 'block';
                isValid = false;
            } else {
                confirmPasswordError.textContent = ''
                confirmPasswordError.style.display = 'none';
            }
            // Ensure new password is not the same as the current password
            if (currentPassword === newPassword && currentPassword) {
                newPasswordError.textContent = 'New password cannot be the same as the current password';
                newPasswordError.style.display = 'block';
                isValid = false;
            }

            // Check form validity before proceeding
            if (!isValid) {
                return;  // Do not proceed if form is invalid
            }

            // Send AJAX request to change password
            fetch('/changePassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ currentPassword, newPassword }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Password Changed',
                            text: 'Your password has been changed successfully',
                            icon: 'success',

                        })
                        document.getElementById('changePasswordForm').reset();
                        document.getElementById('changePasswordForm').style.display = 'none';
                        document.getElementById('showChangePasswordForm').style.display = 'block';

                    } else {

                        swal.fire({
                            title: 'Error',
                            text: data.message || 'Failed to change password',
                            icon: 'error',
                            confirmButtonText: 'Try again'
                        })
                    }
                })
                .catch(error => {
                    console.error('Error:', error);

                    Swal.fire({
                        title: 'Error',
                        text: 'An error occurred while changing the password',
                        icon: 'error',

                    })
                });
        });

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling;

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        }

        function showMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show mt-3`;
            alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;

            const profileSection = document.getElementById('profile');
            profileSection.insertBefore(alertDiv, profileSection.firstChild);

            setTimeout(() => alertDiv.remove(), 5000);
        }


    </script>
    <!--------------------------------------------------------------Edit Address Section---------------------------->
    <script>
        function validateForm(addressId, event) {
            event.preventDefault();
            const form = event.target;
            let isValid = true;

            // Reset all error states
            const errorMessages = form.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());

            // Validation rules
            const validations = {
                name: {
                    pattern: /^[A-Za-z\s]{2,}$/,
                    message: 'Name should contain only letters and be at least 2 characters long'
                },
                phone: {
                    pattern: /^\d{10}$/,
                    message: 'Please enter a valid 10-digit mobile number'
                },
                pincode: {
                    pattern: /^\d{6}$/,
                    message: 'Please enter a valid 6-digit pincode'
                },
                city: {
                    pattern: /^[A-Za-z\s]{2,}$/,
                    message: 'City should contain only letters and be at least 2 characters long'
                },
                landMark: {
                    required: true,
                    message: 'Please enter a landmark'
                },
                district: {
                    required: true,
                    message: 'Please enter your district'
                },
                state: {
                    required: true,
                    message: 'Please select a state'
                },
                altPhone: {
                    pattern: /^\d{10}$/,
                    required: false,
                    message: 'Please enter a valid 10-digit alternate phone number'
                }
            };

            // Helper function to show error message
            function showError(input, message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.style.color = 'red';
                errorDiv.style.fontSize = '12px';
                errorDiv.style.marginTop = '5px';
                errorDiv.textContent = message;
                input.parentNode.appendChild(errorDiv);
                input.style.borderColor = 'red';
                isValid = false;
            }

            // Validate each field
            Object.keys(validations).forEach(fieldName => {
                const input = form.querySelector(`[name="${fieldName}"]`);
                if (!input) return;

                const validation = validations[fieldName];
                const value = input.value.trim();

                // Reset styles
                input.style.borderColor = '';

                // Required field validation
                if (validation.required !== false && !value) {
                    showError(input, validation.message);
                    return;
                }

                // Pattern validation
                if (validation.pattern && value) {
                    if (!validation.pattern.test(value)) {
                        showError(input, validation.message);
                    }
                }
            });
            function toggleEditForm(addressId) {
                const editForm = document.getElementById(`editForm-${addressId}`);
                editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
            }

            function submitEditForm(addressId, event) {
                event.preventDefault();
                const form = event.target;
                if (!validateForm(addressId, event)) return

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());


                fetch(`/editAddress/${addressId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            // Update the address display
                            const addressBox = document.getElementById(`address-${addressId}`);
                            addressBox.querySelector('.fw-bold').textContent = data.addressType;
                            addressBox.querySelector('div:nth-child(2)').textContent = data.name;
                            addressBox.querySelector('div:nth-child(3)').textContent = `${data.city}, ${data.landMark}, ${data.district}`;
                            addressBox.querySelector('div:nth-child(4)').textContent = `${data.state}, ${data.pincode}`;
                            addressBox.querySelector('div:nth-child(5)').textContent = `Phone: ${data.phone}`;

                            toggleEditForm(addressId);
                            showMessage('Address updated successfully', 'success');
                        } else {
                            showMessage('Failed to update address', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('An error occurred while updating the address', 'error');
                    });
            }

            function deleteAddress(addressId) {
                if (confirm('Are you sure you want to delete this address?')) {
                    fetch(`/deleteAddress/${addressId}`, {
                        method: 'POST',
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                // Remove the address from the DOM
                                const addressBox = document.getElementById(`address-${addressId}`);
                                addressBox.remove();
                                showMessage('Address deleted successfully', 'success');
                            } else {
                                showMessage('Failed to delete address', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showMessage('An error occurred while deleting the address', 'error');
                        });
                }
            }

            function showMessage(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show mt-3`;
                alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
`;

                const addressesSection = document.getElementById('addresses');
                addressesSection.insertBefore(alertDiv, addressesSection.firstChild);

                setTimeout(() => alertDiv.remove(), 5000);
            }
    </script>

    </script>
    <!-----------------------------------------toggle address form------------------------------------------------------>
    <script>
            function toggleAddForm() {
                const form = document.getElementById('addAddressForm');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }

            function toggleEditForm(addressId) {
                const editForm = document.getElementById(`editForm-${addressId}`);
                editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';

            }
    </script>
    <!-------------------------------------------------address form ----------------------------------------------------------------------------->

    <script>
            // Form validation and submission handling
            document.addEventListener('DOMContentLoaded', function () {
                const addressForm = document.getElementById('addressForm');

                if (!addressForm) return;

                // Form submission handler
                addressForm.addEventListener('submit', async function (event) {
                    event.preventDefault();

                    // Get form data
                    const formData = {
                        name: addressForm.name.value.trim(),
                        phone: addressForm.phone.value.trim(),
                        pincode: addressForm.pincode.value.trim(),
                        city: addressForm.city.value.trim(),
                        landMark: addressForm.landMark.value.trim(),
                        district: addressForm.district.value.trim(),
                        state: addressForm.state.value,
                        altPhone: addressForm.altPhone.value.trim(),
                        addressType: addressForm.addressType.value
                    };

                    // Validate required fields
                    const requiredFields = ['name', 'phone', 'pincode', 'city', 'landMark', 'district', 'state', 'addressType'];
                    let isValid = true;

                    requiredFields.forEach(field => {
                        const input = addressForm[field];
                        if (!formData[field]) {
                            input.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            input.classList.remove('is-invalid');
                            input.classList.add('is-valid');
                        }
                    });

                    if (!isValid) {
                        showMessage('Please fill all required fields', 'error');
                        return;
                    }

                    // Validate phone number format
                    if (!/^\d{10}$/.test(formData.phone)) {
                        addressForm.phone.classList.add('is-invalid');
                        showMessage('Please enter a valid 10-digit phone number', 'error');
                        return;
                    }

                    // Validate pincode format
                    if (!/^\d{6}$/.test(formData.pincode)) {
                        addressForm.pincode.classList.add('is-invalid');
                        showMessage('Please enter a valid 6-digit pincode', 'error');
                        return;
                    }

                    // Validate alternate phone if provided
                    if (formData.altPhone && !/^\d{10}$/.test(formData.altPhone)) {
                        addressForm.altPhone.classList.add('is-invalid');
                        showMessage('Please enter a valid alternate phone number', 'error');
                        return;
                    }

                    try {
                        const response = await fetch('/addAddress', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Add the new address to the list
                            if (result.addresses && result.addresses.length > 0) {
                                addAddressToList(result.addresses[result.addresses.length - 1]);
                            }

                            // Reset form and validation states
                            addressForm.reset();
                            addressForm.querySelectorAll('.is-valid, .is-invalid').forEach(input => {
                                input.classList.remove('is-valid', 'is-invalid');
                            });

                            // Hide form and show success message
                            toggleAddForm();
                            showMessage('Address added successfully', 'success');
                        } else {
                            showMessage(result.message || 'Error adding address', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showMessage('An error occurred while saving the address', 'error');
                    }
                });
            });

            // Helper function to show messages
            function showMessage(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
                alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
`;

                const addressesSection = document.getElementById('addresses');
                const existingAlert = addressesSection.querySelector('.alert');
                if (existingAlert) {
                    existingAlert.remove();
                }

                addressesSection.insertBefore(alertDiv, addressesSection.firstChild);

                setTimeout(() => alertDiv.remove(), 5000);
            }
            // Modified addAddressToList function
            function addAddressToList(address) {
                const addressesContainer = document.querySelector('.saved-addresses');
                if (addressesContainer.querySelector('p')?.textContent === 'No addresses found.') {
                    addressesContainer.innerHTML = '';
                }

                const newAddressHtml = `
    <div class="address-box" id="address-${address._id}">
        <div class="d-flex justify-content-between mb-2">
            <span class="fw-bold">${address.addressType}</span>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2" onclick="toggleEditForm('${address._id}')">Edit</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAddress('${address._id}')">Delete</button>
            </div>
        </div>
        <div>${address.name || 'No Name'}</div>
        <div>${address.city}, ${address.landMark}, ${address.district}</div>
        <div>${address.state}, ${address.pincode}</div>
        <div>Phone: ${address.phone}</div>
        ${address.altPhone ? `<div>Alt Phone: ${address.altPhone}</div>` : ''}
    </div>
`;
                addressesContainer.insertAdjacentHTML('beforeend', newAddressHtml);
            }
    </script>
    <!--------------------------------------wishlist mgmt------------------------------->
    <script>
        
        function removeFromWishlist(productId) {
    // Add your AJAX call to remove item from wishlist
    fetch(`/wishlist/remove/${productId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the wishlist section
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

function addToCart(productId) {
    console.log('reached add to cart route')
    // Add your AJAX call to add item to cart
    if(productId.quantity  < 0) {
        Swal.fire({
            title: 'Error',
            text: 'Product is  out of stock.',

        })
    }

    fetch('/addToCart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ productId: productId })
        
    })
    
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('success')
            // Show success message or update cart count
            alert('Item added to cart!');
        }
    })
    .catch(error => {
        console.error('add to cart failed')
        console.error('Error:', error.message)
});
}
        </script>
    <!--Sweet alert-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>