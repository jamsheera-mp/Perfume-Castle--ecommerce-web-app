<%- include('../partials/user/header.ejs') %>

    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow">Home</a>
                    <span></span> Shop <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <form action="/placeOrder" method="POST" id="checkout-form">
                    <div class="row d-flex">
                        <div class="col-md-6">
                            <!-------------------------------------------Order Summary Section Begins ------------------------------------------------------------------------------->

                            <div class="order_review">
                                <div class="mb-20">
                                    <h4>Your Orders</h4>
                                </div>
                                <div class="table-responsive order_table text-center">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th colspan="2">Product</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (cartItems && cartItems.length> 0) { %>
                                                <% let totalPrice=0; %>
                                                    <% cartItems.forEach(item=> { %>
                                                        <% const productTotal=item.price * item.quantity; %>
                                                            <% totalPrice +=productTotal; %>
                                                                <tr>
                                                                    <td class="image product-thumbnail">
                                                                        <img src="/uploads/re-image/<%= item.productId.productImage[0] %>"
                                                                            alt="<%= item.productId.productName %>" />
                                                                    </td>
                                                                    <td>
                                                                        <h5><a
                                                                                href="/product/<%= item.productId._id %>">
                                                                                <%= item.productId.productName %>
                                                                            </a></h5>
                                                                        <span class="product-qty">x <%= item.quantity %>
                                                                        </span>
                                                                    </td>
                                                                    <td>$<%= productTotal.toFixed(2) %>
                                                                    </td>
                                                                </tr>
                                                                <% }); %>
                                                                    <tr>
                                                                        <th>SubTotal</th>
                                                                        <td colspan="2">$<%= totalPrice.toFixed(2) %>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Shipping</th>
                                                                        <td colspan="2"><em>Free Shipping</em></td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Total</th>
                                                                        <td colspan="2" class="product-subtotal"><span
                                                                                class="font-xl text-brand fw-900">$<%=
                                                                                    totalPrice.toFixed(2) %></span></td>
                                                                    </tr>
                                                                    <% } else { %>
                                                                        <tr>
                                                                            <td colspan="3">Your cart is empty.</td>
                                                                        </tr>
                                                                        <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-------------------------------------------Order Summary Section Ends ------------------------------------------------------------------------------->


                            <!----------------------------------------------------Payment Method Selection Begins-------------------------------------------------->
                            <div class="payment-method mt-5">
                                <div class="card mt-5">
                                    <div class="card-header">
                                        <h4 class="mb-30">Payment</h4>
                                    </div>

                                    <div class="card-body">
                                        <div class="payment_option">
                                            <div class="custome-radio">
                                                <input class="form-check-input" required="" type="radio"
                                                    name="payment_option" id="exampleRadios3" value="CashOnDelivery"
                                                    checked="" style="transform: scale(0.8);">
                                                <label class="form-check-label" for="exampleRadios3"
                                                    data-bs-toggle="collapse" data-target="#cashOnDelivery"
                                                    aria-controls="cashOnDelivery">Cash On Delivery</label>
                                            </div>
                                            <div class="custome-radio">
                                                <input class="form-check-input" required="" type="radio"
                                                    name="payment_option" id="exampleRadios4" value="Online"
                                                    style="transform: scale(0.8);">
                                                <label class="form-check-label" for="exampleRadios4"
                                                    data-bs-toggle="collapse" data-target="#cardPayment"
                                                    aria-controls="cardPayment">Online Payment</label>
                                            </div>
                                            <div class="custome-radio">
                                                <input class="form-check-input" required="" type="radio"
                                                    name="payment_option" id="exampleRadios5" value="wallet"
                                                    style="transform: scale(0.8);">
                                                <label class="form-check-label" for="exampleRadios5"
                                                    data-bs-toggle="collapse" data-target="#wallet"
                                                    aria-controls="wallet">Wallet</label>
                                            </div>
                                        </div>
                                    </div>

                                    <a id="placeOrderBtn" class="btn btn-fill-out btn-block mt-30">Place Order</a>
                                </div>
                            </div>
                        </div>


                        <!----------------------------------------------------Payment Method Selection Ends -------------------------------------------------->




                        <!----------------------------------------------------Billing Details  -------------------------------------------------->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <div class="mb-25">
                                        <h4>Billing Details</h4>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!--------------------------------------------Existing addresses selection  ---------------------------------------->
                                    <div class="card">
                                        <div class="card-header">
                                            <h6>Use Existing Address</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <% if (addresses && addresses.length> 0) { %>
                                                <% addresses.forEach((addr, index)=> { %>
                                                    <% addr.address.forEach((addressItem)=> { %>
                                                        <div class="form-check">
                                                            <div>
                                                                <input class="form-check-input" type="radio"
                                                                    name="addressType" value="<%= addressItem._id %>"
                                                                    id="address<%= index %>"
                                                                    data-address='<%= JSON.stringify(addressItem) %>'
                                                                    checked>

                                                                <div id="address-<%= addressItem._id %>">
                                                                    <span class="badge bg-secondary">
                                                                        <%= addressItem.addressType %>
                                                                    </span>
                                                                    <p>
                                                                        <%= addressItem.name %>
                                                                            <br>
                                                                            <%= addressItem.phone %>


                                                                                <br>

                                                                                <%= addressItem.city %>, <%=
                                                                                        addressItem.landMark %>,
                                                                                        <%= addressItem.district %>, <%=
                                                                                                addressItem.state %>,
                                                                                                <strong>
                                                                                                    <%= addressItem.pincode
                                                                                                        %>
                                                                                                </strong>
                                                                    </p>

                                                                </div>
                                                            </div>
                                                            <!----------------------------------------------------------- Edit Address Form Begins ----------------------------------------------->
                                                            <!-- Hidden Edit Form -->
                                                            <div id="editForm-<%= index %>" class="edit-form"
                                                                style="display: none;">
                                                                <form action="/editAddress/<%= addressItem._id %>"
                                                                    method="POST" id="editAddressForm-<%= index %>"
                                                                    onsubmit="submitEditForm('<%= index%>')">
                                                                    <div class="row mb-3">
                                                                        <div class="col-6">
                                                                            <label for="name-<%= index %>"
                                                                                class="form-label">
                                                                                Name</label>
                                                                            <input type="text" class="form-control"
                                                                                id="name-<%= index %>" name="name"
                                                                                value="<%= addressItem.name %>"
                                                                                required>
                                                                            <div class="invalid-feedback">Please enter
                                                                                the name.
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-6">
                                                                            <label for="phone-<%= index %>"
                                                                                class="form-label">Phone</label>
                                                                            <input type="text" class="form-control"
                                                                                id="phone-<%= index %>" name="phone"
                                                                                value="<%= addressItem.phone %>"
                                                                                pattern="\d{10}" required>
                                                                            <div class="invalid-feedback">Please enter a
                                                                                valid
                                                                                10-digit
                                                                                mobile number.</div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="row mb-3">
                                                                        <div class="col-6">
                                                                            <label for="pincode-<%= index %>"
                                                                                class="form-label">Pincode</label>
                                                                            <input type="text" class="form-control"
                                                                                id="pincode-<%= index %>" name="pincode"
                                                                                value="<%= addressItem.pincode %>"
                                                                                pattern="\d{6}" required>
                                                                            <div class="invalid-feedback">Please enter a
                                                                                valid
                                                                                6-digit
                                                                                pincode.</div>
                                                                        </div>
                                                                        <div class="col-6">
                                                                            <label for="city-<%= index %>"
                                                                                class="form-label">City/Town</label>
                                                                            <input type="text" class="form-control"
                                                                                id="city-<%= index %>" name="city"
                                                                                value="<%= addressItem.city %>"
                                                                                required>
                                                                            <div class="invalid-feedback">Please enter
                                                                                the
                                                                                city/town.</div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="mb-3">
                                                                        <label for="landmark-<%= index %>"
                                                                            class="form-label">Landmark</label>
                                                                        <input type="text" class="form-control"
                                                                            id="landmark-<%= index %>" name="landMark"
                                                                            value="<%= addressItem.landMark %>"
                                                                            required>
                                                                        <div class="invalid-feedback">Please enter a
                                                                            landmark.</div>
                                                                    </div>

                                                                    <div class="mb-3">
                                                                        <label for="district-<%= index %>"
                                                                            class="form-label">District</label>
                                                                        <input type="text" class="form-control"
                                                                            id="district-<%= index %>" name="district"
                                                                            value="<%= addressItem.district %>"
                                                                            required>
                                                                        <div class="invalid-feedback">Please enter your
                                                                            district.
                                                                        </div>
                                                                    </div>

                                                                    <div class="mb-3">
                                                                        <label for="state-<%= index %>"
                                                                            class="form-label">State</label>
                                                                        <select name="state" id="state-<%= index %>"
                                                                            class="form-select" required>
                                                                            <option value="" selected disabled>--Select
                                                                                State--
                                                                            </option>
                                                                            <option value="Andaman and Nicobar Islands"
                                                                                <%=addressItem.state==="Andaman and Nicobar Islands"
                                                                                ? 'selected' : '' %>>Andaman and Nicobar
                                                                                Islands
                                                                            </option>
                                                                            <option value="Andhra Pradesh"
                                                                                <%=addressItem.state==="Andhra Pradesh"
                                                                                ? 'selected' : '' %>
                                                                                >Andhra Pradesh</option>
                                                                            <option value="Arunachal Pradesh"
                                                                                <%=addressItem.state==="Arunachal Pradesh"
                                                                                ? 'selected' : '' %>
                                                                                >Arunachal Pradesh</option>
                                                                            <option value="Assam"
                                                                                <%=addressItem.state==="Assam"
                                                                                ? 'selected' : '' %>>Assam</option>
                                                                            <option value="Bihar"
                                                                                <%=addressItem.state==="Bihar"
                                                                                ? 'selected' : '' %>>Bihar</option>
                                                                            <option value="Chandigarh"
                                                                                <%=addressItem.state==="Chandigarh"
                                                                                ? 'selected' : '' %>>Chandigarh</option>
                                                                            <option value="Chhattisgarh"
                                                                                <%=addressItem.state==="Chhattisgarh"
                                                                                ? 'selected' : '' %>
                                                                                >Chhattisgarh</option>
                                                                            <option value="Dadra and Nagar Haveli"
                                                                                <%=addressItem.state==="Dadra and Nagar Haveli"
                                                                                ? 'selected' : '' %>
                                                                                >Dadra and Nagar Haveli</option>
                                                                            <option value="Daman and Diu"
                                                                                <%=addressItem.state==="Daman and Diu"
                                                                                ? 'selected' : '' %>
                                                                                >Daman and Diu</option>
                                                                            <option value="Delhi"
                                                                                <%=addressItem.state==="Delhi"
                                                                                ? 'selected' : '' %>>Delhi</option>
                                                                            <option value="Goa"
                                                                                <%=addressItem.state==="Goa"
                                                                                ? 'selected' : '' %>
                                                                                >Goa</option>
                                                                            <option value="Gujarat"
                                                                                <%=addressItem.state==="Gujarat"
                                                                                ? 'selected' : '' %>>Gujarat</option>
                                                                            <option value="Haryana"
                                                                                <%=addressItem.state==="Haryana"
                                                                                ? 'selected' : '' %>>Haryana</option>
                                                                            <option value="Himachal Pradesh"
                                                                                <%=addressItem.state==="Himachal Pradesh"
                                                                                ? 'selected' : '' %>
                                                                                >Himachal Pradesh</option>
                                                                            <option value="Jammu and Kashmir"
                                                                                <%=addressItem.state==="Jammu and Kashmir"
                                                                                ? 'selected' : '' %>
                                                                                >Jammu and Kashmir</option>
                                                                            <option value="Jharkhand"
                                                                                <%=addressItem.state==="Jharkhand"
                                                                                ? 'selected' : '' %>>Jharkhand</option>
                                                                            <option value="Karnataka"
                                                                                <%=addressItem.state==="Karnataka"
                                                                                ? 'selected' : '' %>>Karnataka</option>
                                                                            <option value="Kerala"
                                                                                <%=addressItem.state==="Kerala"
                                                                                ? 'selected' : '' %>>Kerala</option>
                                                                            <option value="Ladakh"
                                                                                <%=addressItem.state==="Ladakh"
                                                                                ? 'selected' : '' %>>Ladakh</option>
                                                                            <option value="Lakshadweep"
                                                                                <%=addressItem.state==="Lakshadweep"
                                                                                ? 'selected' : '' %>>Lakshadweep
                                                                            </option>
                                                                            <option value="Madhya Pradesh"
                                                                                <%=addressItem.state==="Madhya Pradesh"
                                                                                ? 'selected' : '' %>
                                                                                >Madhya Pradesh</option>
                                                                            <option value="Maharashtra"
                                                                                <%=addressItem.state==="Maharashtra"
                                                                                ? 'selected' : '' %>>Maharashtra
                                                                            </option>
                                                                            <option value="Manipur"
                                                                                <%=addressItem.state==="Manipur"
                                                                                ? 'selected' : '' %>>Manipur</option>
                                                                            <option value="Meghalaya"
                                                                                <%=addressItem.state==="Meghalaya"
                                                                                ? 'selected' : '' %>>Meghalaya</option>
                                                                            <option value="Mizoram"
                                                                                <%=addressItem.state==="Mizoram"
                                                                                ? 'selected' : '' %>>Mizoram</option>
                                                                            <option value="Nagaland"
                                                                                <%=addressItem.state==="Nagaland"
                                                                                ? 'selected' : '' %>>Nagaland</option>
                                                                            <option value="Odisha"
                                                                                <%=addressItem.state==="Odisha"
                                                                                ? 'selected' : '' %>>Odisha</option>
                                                                            <option value="Puducherry"
                                                                                <%=addressItem.state==="Puducherry"
                                                                                ? 'selected' : '' %>>Puducherry</option>
                                                                            <option value="Punjab"
                                                                                <%=addressItem.state==="Punjab"
                                                                                ? 'selected' : '' %>>Punjab</option>
                                                                            <option value="Rajasthan"
                                                                                <%=addressItem.state==="Rajasthan"
                                                                                ? 'selected' : '' %>>Rajasthan</option>
                                                                            <option value="Sikkim"
                                                                                <%=addressItem.state==="Sikkim"
                                                                                ? 'selected' : '' %>>Sikkim</option>
                                                                            <option value="Tamil Nadu"
                                                                                <%=addressItem.state==="Tamil Nadu"
                                                                                ? 'selected' : '' %>>Tamil Nadu</option>
                                                                            <option value="Telangana"
                                                                                <%=addressItem.state==="Telangana"
                                                                                ? 'selected' : '' %>>Telangana</option>
                                                                            <option value="Tripura"
                                                                                <%=addressItem.state==="Tripura"
                                                                                ? 'selected' : '' %>>Tripura</option>
                                                                            <option value="Uttar Pradesh"
                                                                                <%=addressItem.state==="Uttar Pradesh"
                                                                                ? 'selected' : '' %>
                                                                                >Uttar Pradesh</option>
                                                                            <option value="Uttarakhand"
                                                                                <%=addressItem.state==="Uttarakhand"
                                                                                ? 'selected' : '' %>>Uttarakhand
                                                                            </option>
                                                                            <option value="West Bengal"
                                                                                <%=addressItem.state==="West Bengal"
                                                                                ? 'selected' : '' %>>West Bengal
                                                                            </option>

                                                                        </select>
                                                                        <div class="invalid-feedback">Please select a
                                                                            state.</div>
                                                                    </div>

                                                                    <div class="row mb-3">
                                                                        <div class="col-6">
                                                                            <label for="altPhone-<%= index %>"
                                                                                class="form-label">Alternate
                                                                                Phone (Optional)</label>
                                                                            <input type="text" class="form-control"
                                                                                id="altPhone-<%= index %>"
                                                                                name="altPhone"
                                                                                value="<%= addressItem.altPhone || '' %>">
                                                                        </div>
                                                                        <div class="col-6">
                                                                            <label for="addressType">Address
                                                                                Type</label>
                                                                            <select name="addressType"
                                                                                class="form-select" required>
                                                                                <option value="Home"
                                                                                    <%=addressItem.addressType==='Home'
                                                                                    ? 'selected' : '' %>>Home</option>
                                                                                <option value="Work"
                                                                                    <%=addressItem.addressType==='Work'
                                                                                    ? 'selected' : '' %>>Work</option>
                                                                            </select>
                                                                            <div class="invalid-feedback">Please select
                                                                                an address
                                                                                type.
                                                                            </div>
                                                                        </div>

                                                                    </div>
                                                                    <div class=.d-flex.justify-content-between>
                                                                        <button id="saveEditBtn-<%=index %>"
                                                                            type="submit" class="btn btn-primary">Save
                                                                            Changes</button>
                                                                        <button type="button" class="btn btn-secondary"
                                                                            onclick="toggleEditForm('<%= index %>')">
                                                                            Cancel</button>
                                                                    </div>



                                                                </form>
                                                            </div>

                                                            <!------------------------------------------------- Edit Address Form Ends --------------------------------------------------------------->
                                                            <!---------------------- Edit and Delete Buttons ------------------------->
                                                            <div class="d-flex align-items-center mb-3">

                                                                <button type="button"
                                                                    class="btn btn-sm btn-primary me-2  "
                                                                    onclick="toggleEditForm('<%= index %>')">Edit</button>

                                                                <form action="/deleteAddress/<%= addressItem._id %>"
                                                                    method="POST">
                                                                    <button type="submit"
                                                                        class="btn btn-sm btn-danger">Delete</button>
                                                                </form>
                                                            </div>
                                                            <% }); %>
                                                                <% }) %>
                                                                    <% } else { %>
                                                                        <p>No existing addresses found.Please add a
                                                                            new
                                                                            address
                                                                        </p>
                                                                        <% } %>
                                                        </div>
                                        </div>
                                    </div>
                                </div>
                                <!--------------------------------------------Existing addresses selection Ends ---------------------------------------->
                            </div>
                            <!----------------------------------------------Add New Address Section Begins  ------------------------------------------------------------->

                            <div class="card">
                                <div class="card-header">
                                    <h6 id="addAddressToggle" style="cursor:pointer;">+ Add New Address</h6>
                                </div>
                                <div class="card-body">
                                    <div id="new-address" style="display: none;" class="addAddress">
                                        <form action="/addAddress" method="POST" id="addAddressForm" novalidate>
                                            <div class="row mb-3">
                                                <div class="col-6">
                                                    <input type="text" name="name" id="name" class="form-control"
                                                        placeholder="Name" required>
                                                    <div class="invalid-feedback">Please enter the name.</div>
                                                </div>
                                                <div class="col-6">
                                                    <input type="text" name="phone" id="phone" class="form-control"
                                                        placeholder="10-digit mobile number" pattern="\d{10}" required>
                                                    <div class="invalid-feedback">Please enter a valid 10-digit mobile
                                                        number.</div>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-6">
                                                    <input type="text" name="pincode" id="pincode" class="form-control"
                                                        placeholder="Pincode" pattern="\d{6}" required>
                                                    <div class="invalid-feedback">Please enter a valid 6-digit pincode.
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <input type="text" name="city" id="city" class="form-control"
                                                        placeholder="City/Town" required>
                                                    <div class="invalid-feedback">Please enter the city/town.</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <input type="text" name="landMark" id="landMark" class="form-control"
                                                    placeholder="Landmark" required>
                                                <div class="invalid-feedback">Please enter a landmark.</div>
                                            </div>
                                            <div class="mb-3">
                                                <input type="text" name="district" id="district" class="form-control"
                                                    placeholder="District" required>
                                                <div class="invalid-feedback">Please enter your district.</div>
                                            </div>
                                            <div class="mb-3">
                                                <select name="state" id="state" id="state" class="form-select" required>

                                                    <option value="" selected disabled>--Select State--</option>
                                                    <option value="Andaman and Nicobar Islands">Andaman and Nicobar
                                                        Islands
                                                    </option>
                                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                                    <option value="Assam">Assam</option>
                                                    <option value="Bihar">Bihar</option>
                                                    <option value="Chandigarh">Chandigarh</option>
                                                    <option value="Chhattisgarh">Chhattisgarh</option>
                                                    <option value="Dadra and Nagar Haveli">Dadra and Nagar Haveli
                                                    </option>
                                                    <option value="Daman and Diu">Daman and Diu</option>
                                                    <option value="Delhi">Delhi</option>
                                                    <option value="Goa">Goa</option>
                                                    <option value="Gujarat">Gujarat</option>
                                                    <option value="Haryana">Haryana</option>
                                                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                                                    <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                                    <option value="Jharkhand">Jharkhand</option>
                                                    <option value="Karnataka">Karnataka</option>
                                                    <option value="Kerala">Kerala</option>
                                                    <option value="Ladakh">Ladakh</option>
                                                    <option value="Lakshadweep">Lakshadweep</option>
                                                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                                                    <option value="Maharashtra">Maharashtra</option>
                                                    <option value="Manipur">Manipur</option>
                                                    <option value="Meghalaya">Meghalaya</option>
                                                    <option value="Mizoram">Mizoram</option>
                                                    <option value="Nagaland">Nagaland</option>
                                                    <option value="Odisha">Odisha</option>
                                                    <option value="Puducherry">Puducherry</option>
                                                    <option value="Punjab">Punjab</option>
                                                    <option value="Rajasthan">Rajasthan</option>
                                                    <option value="Sikkim">Sikkim</option>
                                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                                    <option value="Telangana">Telangana</option>
                                                    <option value="Tripura">Tripura</option>
                                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                                    <option value="Uttarakhand">Uttarakhand</option>
                                                    <option value="West Bengal">West Bengal</option>
                                                </select>
                                                <div class="invalid-feedback">Please select a state.</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-6">
                                                    <input type="text" name="altPhone" id="altphone"
                                                        class="form-control" placeholder="Alternate Phone (Optional)">
                                                    <div class="invalid-feedback">Please enter a valid alternate phone
                                                        number.</div>
                                                </div>
                                                <div class="col-6">
                                                    <label for="addressType" id="type">Address Type</label>
                                                    <select name="addressType" class="form-select" required>
                                                        <option value="Home">Home</option>
                                                        <option value="Work">Work</option>
                                                    </select>
                                                    <div class="invalid-feedback">Please select an address type.</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <button id="saveAddressBtn" type="submit" class="btn btn-primary">Save
                                                    Address</button>

                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!----------------------------------------------Add New Address Section Ends  ------------------------------------------------------------->
                        </div> <!--billing details column ends-->
                    </div> <!--Row ends-->
                    <!-------------------------------------------Billing Details End ------------------------------------------------------------------------------->
                </form>

            </div> <!-- Container ends-->



        </section>
        <script>

        // Form validation functions
        function validateAddressForm(formData) {
            const validations = {
                name: {
                    test: value => value.length >= 2 && /^[a-zA-Z\s]{2,50}$/.test(value),
                    message: 'Name must be 2-50 characters long and contain only letters'
                },
                phone: {
                    test: value => /^\d{10}$/.test(value),
                    message: 'Phone must be exactly 10 digits'
                },
                pincode: {
                    test: value => /^\d{6}$/.test(value),
                    message: 'Pincode must be exactly 6 digits'
                },
                city: {
                    test: value => value.length >= 2 && /^[a-zA-Z\s]{2,50}$/.test(value),
                    message: 'City must be 2-50 characters long and contain only letters'
                },
                landMark: {
                    test: value => value.length >= 3,
                    message: 'Landmark must be at least 3 characters long'
                },
                district: {
                    test: value => value.length >= 2 && /^[a-zA-Z\s]{2,50}$/.test(value),
                    message: 'District must be 2-50 characters long and contain only letters'
                },
                state: {
                    test: value => value.length > 0,
                    message: 'Please select a state'
                }
            };
        
            const errors = {};
            let isValid = true;
        
            for (const [field, validation] of Object.entries(validations)) {
                const value = formData.get(field);
                if (!validation.test(value)) {
                    errors[field] = validation.message;
                    isValid = false;
                }
            }
        
            return { isValid, errors };
        }
        
        document.addEventListener('DOMContentLoaded', function () {
            // Address Form Toggle
            const addAddressToggle = document.getElementById('addAddressToggle');
            const newAddressForm = document.getElementById('new-address');
        
            addAddressToggle.addEventListener('click', function () {
                if (newAddressForm.style.display === 'none' || newAddressForm.style.display === '') {
                    newAddressForm.style.display = 'block';
                } else {
                    newAddressForm.style.display = 'none';
                }
            });
        
            // Add Address Form Submission
            const addAddressForm = document.getElementById('addAddressForm');
            if (addAddressForm) {
                addAddressForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const { isValid, errors } = validateAddressForm(formData);
        
                    if (!isValid) {
                        Object.keys(errors).forEach(field => {
                            const input = document.getElementById(field);
                            const feedback = input.nextElementSibling;
                            input.classList.add('is-invalid');
                            if (feedback) feedback.textContent = errors[field];
                        });
                        return;
                    }
        
                    fetch('/addAddress', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Address added successfully!');
                                location.reload();
                            } else {
                                alert('Error adding address: ' + data.message);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                });
            }
        
            // Address Deletion
            function deleteAddress(addressId) {
                if (confirm('Are you sure you want to delete this address?')) {
                    fetch(`/deleteAddress/${addressId}`, {
                        method: 'POST',
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('address deleting message:', data);
        
                            if (data.success) {
                                Swal.fire('success', data.message, 'success')
                                const addressCard = document.querySelector(`#address-${addressId}`);
                                if (addressCard) {
                                    addressCard.remove();
                                }
                            } else {
                                Swal.fire('Error', data.message, 'error')
                            }
                        })
                        .catch(error => {
                            Swal.fire('Error', 'Something went wrong', 'error')
                            console.error('Error:', error)
                        })
                }
            }
        
            // Edit Address
            function toggleEditForm(index) {
                const editForm = document.getElementById(`editForm-${index}`);
                if (editForm.style.display === 'none' || editForm.style.display === '') {
                    editForm.style.display = 'block';
                } else {
                    editForm.style.display = 'none';
                }
            }
        
            function submitEditForm(index) {
                const form = document.getElementById(`editAddressForm-${index}`);
                const formData = new FormData(form);
        
                fetch(form.getAttribute('action'), {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload()
                            updateAddressOnPage(index, data.address);
                            toggleEditForm(index);
                        } else {
                            alert('Error updating address. Please try again.');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        
            function updateAddressOnPage(index, updatedAddress) {
                const addressElement = document.querySelector(`#editForm-${index}`).previousElementSibling;
                addressElement.querySelector('strong').innerText = updatedAddress.name || 'No Name';
                addressElement.querySelectorAll('p')[1].innerText = `${updatedAddress.city}, ${updatedAddress.landMark}, ${updatedAddress.district}, ${updatedAddress.state}, ${updatedAddress.pincode}`;
            }
        
            // Edit Address Form
            const editForms = document.querySelectorAll('[id^="editAddressForm-"]');
            editForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const { isValid, errors } = validateAddressForm(formData);
        
                    if (!isValid) {
                        Object.keys(errors).forEach(field => {
                            const input = this.querySelector(`[name="${field}"]`);
                            const feedback = input.nextElementSibling;
                            input.classList.add('is-invalid');
                            if (feedback) feedback.textContent = errors[field];
                        });
                        return;
                    }
        
                    fetch(this.getAttribute('action'), {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error updating address: ' + data.message);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            });
        
            // Place Order
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            if (placeOrderBtn) {
                placeOrderBtn.addEventListener('click', function() {
                    const selectedAddressRadio = document.querySelector('input[name="addressType"]:checked');
                    const selectedPaymentRadio = document.querySelector('input[name="payment_option"]:checked');
                    console.log('Selected address:', selectedAddressRadio.value);
                    console.log('Selected payment method:', selectedPaymentRadio.value);
                    
        
                    if (!selectedAddressRadio) {
                        alert('Please select a delivery address');
                        return;
                    }
        
                    if (!selectedPaymentRadio) {
                        alert('Please select a payment method');
                        return;
                    }
                    const addressId = selectedAddressRadio.value;
                    const requestData = {
                        address: addressId,
                        paymentMethod: selectedPaymentRadio.value
                    };
                    console.log('Request data:', requestData);
                    fetch('/placeOrder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '/orderSuccess';
                        } else {
                            alert(data.message || 'Error occurred while placing order');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while placing the order');
                    });
                });
            }
        });
        
        // Reset validation state when input changes
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('is-invalid')) {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = '';
                }
            }
        });
    </script>


        <!------------------------------- Place Order Form Submission Ends-------------------------------->

        <%- include('../partials/user/footer.ejs') %>