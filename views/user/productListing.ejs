<%- include('../partials/user/header.ejs') %>

    <section class="content-main mt-5">
        <div class="content-header pt-5">
            <div>
                <h2 class="content-title card-title ms-5 ps-5">Our Products</h2>
                <p class="mb-5 ms-5 ps-5">Shop now</p>
            </div>
        </div>

        <div class="card mb-4 ">
            <header class="card-header">
                <div class="row gx-3 ">

                    <!-- Search products -->
                    <div class="col-lg-4 col-md-6 me-auto ms-5 ps-5">
                        <form action="/product" method="GET">
                            <input type="text" name="search" value="<%= typeof search !== 'undefined' ? search : '' %>"
                                placeholder="Search..." class="form-control"
                                onkeydown="if(event.key === 'Enter'){ this.form.submit(); }">
                        </form>
                    </div>
                    <!-- Search products Ends -->

                    <!-- Sort products -->
                    <div class="col-lg-3 col-6 col-md-3">
                        <select class="form-select" id="sortBy" name="sortBy">
                            <option value="popularity" <%=filters.sortBy==='popularity' ? 'selected' : '' %>>
                                Popularity
                            </option>
                            <option value="price-low-high" <%=filters.sortBy==='price-low-high' ? 'selected' : '' %>>
                                Price: Low to High
                            </option>
                            <option value="price-high-low" <%=filters.sortBy==='price-high-low' ? 'selected' : '' %>>
                                Price: High to Low
                            </option>
                            <option value="average-rating" <%=filters.sortBy==='average-rating' ? 'selected' : '' %>>
                                Average Rating
                            </option>
                            <option value="new-arrivals" <%=filters.sortBy==='new-arrivals' ? 'selected' : '' %>>
                                New Arrivals
                            </option>
                            <option value="a-z" <%=filters.sortBy==='a-z' ? 'selected' : '' %>>
                                A to Z
                            </option>
                            <option value="z-a" <%=filters.sortBy==='z-a' ? 'selected' : '' %>>
                                Z to A
                            </option>
                        </select>
                    </div>
                    <!-- Sort products Ends -->

                </div>
            </header> <!-- card header ends -->

            <!------------------------------Product Filter Section------------------------------>

            <div class="card-body">
                <div class="row gx-3">
                    <!-- Filters Sidebar -->
                    <div class="col-lg-2 col-6 col-md-3">

                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Filters</h5>

                                <!-- Category Filter -->
                                <div class="mb-4">
                                    <h6 class="mb-3">Categories</h6>
                                    <div class="filter-group">
                                        <select class="form-select" name="category" id="category">
                                            <option value="">Select a category</option>
                                            <% categories.forEach(category=> { %>
                                                <option value="<%= category._id %>"
                                                    <%=filters.selectedCategories.includes(category._id.toString())
                                                    ? 'selected' : '' %>>
                                                    <%= category.name %>
                                                </option>
                                                <% }) %>
                                        </select>
                                    </div>
                                </div>

                                <!-- Brand Filter -->
                                <div class="mb-4">
                                    <h6 class="mb-3">Brands</h6>
                                    <div class="filter-group">
                                        <select class="form-select" name="brand" id="brand">
                                            <option value="">Select a brand</option>
                                            <% brands.forEach(brand=> { %>
                                                <option value="<%= brand._id %>"
                                                    <%=filters.selectedBrands.includes(brand._id.toString())
                                                    ? 'selected' : '' %>>
                                                    <%= brand.brandName %>
                                                </option>
                                                <% }) %>
                                        </select>
                                    </div>
                                </div>

                                <!-- Price Range Filter -->
                                <div class="mb-4">
                                    <h6 class="mb-3">Price Range</h6>
                                    <div class="price-range">
                                        <input type="number" class="form-control mb-2" id="minPrice"
                                            placeholder="Min Price" value="<%= filters.minPrice || '' %>">
                                        <input type="number" class="form-control" id="maxPrice" placeholder="Max Price"
                                            value="<%= filters.maxPrice || '' %>">
                                    </div>
                                </div>

                                <!-- Apply Filters Button -->
                                <button class="btn btn-primary w-100" onclick="applyFilters()">Apply Filters</button>
                            </div>
                        </div>
                    </div>
                    <!------------------------------Product Filter Section Ends------------------------------>

                    <div class="col-lg-10 col-md-9">
                        <div class="row gx-3 row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 row-cols-xxl-5">
                            <% if (products.length===0) { %>
                                <div class="col-12">
                                    <div class="alert alert-danger text-center" role="alert">
                                        No products available in this category or in the brands.
                                    </div>
                                </div>
                                <% } else { %>
                                    <% products.forEach(product=> { %>
                                        <div class="col">
                                            <div class="card card-product-grid ms-5 ps-5">
                                                <a href="/product/<%= product._id %>" class="img-wrap">
                                                    <img src="/uploads/re-image/<%= product.productImage[0] %>"
                                                        alt="<%= product.productName %>">
                                                </a>
                                                <div class="info-wrap text-center">
                                                    <a href="#" class="title text-truncate">
                                                        <%= product.productName %>
                                                    </a>
                                                    <div class="price mb-2 text-center">â‚¹<%=
                                                            product.salePrice.toFixed(2) %>
                                                    </div>

                                                    <!-- Display Stock Left -->
                                                    <div class="stock-info mb-2 text-center">
                                                        <%= product.quantity> 0 ? `Stock left: ${product.quantity}` :
                                                            'Out of stock' %>
                                                    </div>

                                                    <form id="addToCartForm-<%= product._id %>" action="/addToCart"
                                                        method="POST">
                                                        <input type="hidden" name="productId"
                                                            value="<%= product._id %>">
                                                        <input type="hidden" name="quantity" value="1">

                                                        <% if (product.isInCart) { %>
                                                            <!-- If the product is already in the cart, show "Go to Cart" button -->
                                                            <a href="/cart"
                                                                class="btn btn-sm font-sm rounded btn-brand">
                                                                <i class="material-icons md-shopping_cart"></i> Go to
                                                                Cart
                                                            </a>
                                                            <% } else { %>
                                                                <!-- Otherwise, show the "Add to Cart" button -->
                                                                <button type="submit"
                                                                    class="btn btn-sm font-sm rounded btn-brand addToCartBtn"
                                                                    <%=product.quantity===0 ? 'disabled' : '' %> >
                                                                    <i class="material-icons md-add_shopping_cart"></i>
                                                                    Add to Cart
                                                                </button>
                                                                <% } %>
                                                                 <!-- Error/Success Message placeholders -->
                                                    <div id="cartMessage-<%= product._id %>" class="cart-message"
                                                        style="display: none;"></div>
                                                    </form>

                                                   

                                                    <% if (product.productOffer) { %>
                                                        <p class="discount">
                                                            <%= product.productOffer %>% OFF
                                                        </p>
                                                        <% } %>
                                                </div>
                                            </div><!-- card-product end -->
                                        </div><!-- col end -->
                                        <% }) %>
                                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <nav aria-label="Page navigation example" class="d-flex justify-content-center mt-4">
            <ul class="pagination">
                <% for (let i=1; i <=pagination.totalPages; i++) { %>
                    <li class="page-item <%= pagination.currentPage == i ? 'active' : '' %>">
                        <a class="page-link" href="#" onclick="goToPage('<%= i %>'); return false;">
                            <%= i %>
                        </a>
                    </li>
                    <% } %>
            </ul>
        </nav>
    </section>

    <script>
        function goToPage(page) {
            const currentUrl = new URL(window.location.href);

            // Preserve all current filter parameters
            currentUrl.searchParams.set('page', page);

            // Don't remove the filters when changing pages
            window.location.href = currentUrl.toString();
        }

        document.getElementById('sortBy').addEventListener('change', function () {
            applyFilters();
        });

        function applyFilters() {
            const currentUrl = new URL(window.location.href);

            const selectedCategory = document.getElementById('category').value;
            const selectedBrand = document.getElementById('brand').value;
            // Get price range
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;

            // Get sort option
            const sortBy = document.getElementById('sortBy').value;

            // Clear existing parameters
            currentUrl.searchParams.delete('category');
            currentUrl.searchParams.delete('brand');
            currentUrl.searchParams.delete('minPrice');
            currentUrl.searchParams.delete('maxPrice');

            // Add new parameters
            if (selectedCategory) currentUrl.searchParams.set('category', selectedCategory);
            if (selectedBrand) currentUrl.searchParams.set('brand', selectedBrand);
            if (minPrice) currentUrl.searchParams.set('minPrice', minPrice);
            if (maxPrice) currentUrl.searchParams.set('maxPrice', maxPrice);
            if (sortBy) currentUrl.searchParams.set('sortBy', sortBy);

            window.location.href = currentUrl.toString();
        }
    </script>

    <script>
     document.querySelectorAll('.addToCartBtn').forEach(button => {
    button.addEventListener('click', async function (event) {
        event.preventDefault();  // Prevent page refresh or redirect
        const form = event.target.closest('form'); // Get the related form
        const formData = new FormData(form); // Extract form data
        const productId = formData.get('productId');
        

        try {
            const response = await fetch('/addToCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    productId: formData.get('productId'),
                    quantity: formData.get('quantity')
                })
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                icon: 'success',
                title: 'Product added to cart',
                text: 'Item successfully added to your cart!',
                confirmButtonText: 'OK'
            });

                // Optionally update the button to "Go to Cart" or disable it
                event.target.innerHTML = '<i class="material-icons md-shopping_cart"></i> Go to Cart';
                event.target.disabled = true; // Disable button after adding
            } else {
                throw new Error(data.error || 'Failed to add to cart');
            }
        } catch (error) {
            console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: error.message || 'An error occurred while adding to cart',
            confirmButtonText: 'OK'
        });
        }
    });
});


    </script>

    <%- include('../partials/user/footer.ejs') %>