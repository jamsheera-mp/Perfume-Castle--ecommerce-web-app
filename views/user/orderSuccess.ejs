<%- include('../partials/user/header.ejs') %>

<style>
    .order-success-container {
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .order-details-card {
        transition: all 0.3s ease;
    }
    .order-details-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        color: white;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    .toast.show {
        opacity: 1;
    }
    .toast.success {
        background-color: #28a745;
    }
    .toast.error {
        background-color: #dc3545;
    }
</style>

<main class="main">
    <div class="container py-5">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Order Details</li>
            </ol>
        </nav>

        <div class="order-success-container p-4 mt-4">
            <h2 class="text-center mb-4"><%= orderStatus === 'Cancelled' ? 'Order Cancellation' : 'Order Success' %></h2>
            <span class="d-block text-center mb-4 <%= orderStatus === 'Cancelled' ? 'text-danger' : 'text-success' %>" data-order-status="<%= orderId %>">
                <%= orderStatus %>
            </span>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card order-details-card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Order Details</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <th>Order ID:</th>
                                    <td><%= orderId %></td>
                                </tr>
                                <tr>
                                    <th>Order Date:</th>
                                    <td><%= orderDate %></td>
                                </tr>
                                <tr>
                                    <th>Order Status:</th>
                                    <td><%= orderStatus %></td>
                                </tr>
                            </table>
                            <% if(orderStatus !== 'Cancelled'){ %>
                                <form class="cancel-order-form mt-3" data-order-id="<%= orderId %>">
                                    <button type="submit" class="btn btn-danger w-100">Cancel Order</button>
                                </form>
                            <% } %>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card order-details-card h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Shipping Address</h5>
                        </div>
                        <div class="card-body">
                            <p><strong><%= shippingAddress.name %></strong></p>
                            <p><%= shippingAddress.landMark %>, <%= shippingAddress.city %>, <%= shippingAddress.district %></p>
                            <p><%= shippingAddress.state %> - <%= shippingAddress.pincode %></p>
                            <p>Phone: <%= shippingAddress.phone %></p>
                            <% if (shippingAddress.altPhone) { %>
                                <p>Alt Phone: <%= shippingAddress.altPhone %></p>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8 mb-4">
                    <div class="card order-details-card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Ordered Items</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Image</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% orderedItems.forEach(item => { %>
                                            <tr>
                                                <td><%= item.productName %></td>
                                                <td>
                                                    <img src="/uploads/re-image/<%= item.productImage[0] %>" 
                                                         alt="<%= item.productName %>" 
                                                         class="img-thumbnail" 
                                                         style="width: 50px; height: auto;">
                                                </td>
                                                <td>x <%= item.quantity %></td>
                                                <td>$<%= item.price.toFixed(2) %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-4">
                    <div class="card order-details-card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">Order Total</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <th>Subtotal:</th>
                                    <td>$<%= subtotal.toFixed(2) %></td>
                                </tr>
                                <tr>
                                    <th>Shipping:</th>
                                    <td>Free Shipping</td>
                                </tr>
                                <tr>
                                    <th>Total:</th>
                                    <td><strong>$<%= total.toFixed(2) %></strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cancelOrderForms = document.querySelectorAll('.cancel-order-form');

    cancelOrderForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const orderId = this.getAttribute('data-order-id');
            
            fetch(`/cancelOrder/${orderId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin' // This is important for including session cookies
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showToast(data.message, 'success');
                    updateOrderStatus(orderId, 'Cancelled');
                    // Hide the cancel button after successful cancellation
                    this.style.display = 'none';
                } else if (data.error) {
                    showToast(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while cancelling the order', 'error');
            });
        });
    });
});

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    document.body.appendChild(toast);

    // Trigger reflow
    toast.offsetHeight;

    // Add show class for animation
    toast.classList.add('show');

    // Remove the toast after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300); // Wait for fade out animation
    }, 3000);
}

function updateOrderStatus(orderId, newStatus) {
    const statusElement = document.querySelector(`[data-order-status="${orderId}"]`);
    if (statusElement) {
        statusElement.textContent = newStatus;
        statusElement.className = 'd-block text-center mb-4 text-danger';
    }
    
    // Update the page title
    document.querySelector('h2.text-center').textContent = 'Order Cancellation';
}
</script>

<%- include('../partials/user/footer.ejs') %>