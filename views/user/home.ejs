<%- include('../partials/user/header.ejs') %>

<style>
.single-slider-img {
    position: relative;
    overflow: hidden; /* Ensure the pseudo-elements stay within bounds */
}

.single-slider-img img {
    width: 100%; /* Ensures the image fits the container width */
    height: 100%; /* Ensures the image fits the container height */
    object-fit: cover; /* Ensures the image covers the container without distortion */
    border: none;
    box-shadow: none;
    background-color: white; /* Match container background */
}

.single-slider-img::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, white 0%, transparent 20%, transparent 80%, white 100%),
                linear-gradient(to right, white 0%, transparent 10%);
    z-index: 1;
    pointer-events: none;
}



</style>


	<!-----------------------------------------------main slider section starts  -------------------------------------------------------->
	<main class="main">
		<section class="home-slider position-relative pt-50">
			<div class="hero-slider-1 dot-style-1 dot-style-1-position-1">
				<div class="single-hero-slider single-animation-wrap">
					<div class="container">
						<div class="row align-items-center slider-animated-1">
							<div class="col-lg-5 col-md-6">
								<div class="hero-slider-content-2">
									<h4 class="animated">Exclusive Trade-In Offer</h4>
									<h2 class="animated fw-900">Luxurious Fragrances</h2>
									<h1 class="animated fw-900 text-brand">For Every Occasion</h1>
									<p class="animated">Get up to 50% off on selected perfumes</p>
									<a class="animated btn btn-brush btn-brush-3" href="/product"> Shop Now
									</a>
								</div>
							</div>
							<div class="col-lg-7 col-md-6">
								<div class="single-slider-img single-slider-img-1">
									<img class="animated slider-1-1" src="/uploads/slider-images/bottle-with-flower.jpg"
										alt="" style="width: 100%; height: 100%; object-fit: contain;">
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="single-hero-slider single-animation-wrap">
					<div class="container">
						<div class="row align-items-center slider-animated-1">
							<div class="col-lg-5 col-md-6">
								<div class="hero-slider-content-2">
									<h4 class="animated">Special Promotions</h4>
									<h2 class="animated fw-900">Trending Perfumes</h2>
									<h1 class="animated fw-900 text-7">For Him & Her</h1>
									<p class="animated">Discover timeless scents at great prices</p>
									<a class="animated btn btn-brush btn-brush-2" href="/product"> Discover
										Now </a>
								</div>
							</div>
							<div class="col-lg-7 col-md-6">
								<div class="single-slider-img single-slider-img-1">
									<img class="animated slider-1-2 " src="/uploads/slider-images/pic4.jpg" alt=""
										style="width: 100%; height: 100%; object-fit: contain;">
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="single-hero-slider single-animation-wrap">
					<div class="container">
						<div class="row align-items-center slider-animated-1">
							<div class="col-lg-5 col-md-6">
								<div class="hero-slider-content-2">
									<h4 class="animated">New Arrivals</h4>
									<h2 class="animated fw-900">Captivating Scents</h2>
									<h1 class="animated fw-900 text-8">From Top Brands</h1>
									<p class="animated">Shop the latest perfumes and colognes</p>
									<a class="animated btn btn-brush btn-brush-1" href="/product"> Shop Now
									</a>
								</div>
							</div>
							<div class="col-lg-7 col-md-6">
								<div class="single-slider-img single-slider-img-1">
									<img class="animated slider-1-3" src="/uploads/slider-images/pic7.jpg" alt=""
										style="width: 100%; height: 100%; object-fit: contain;">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="slider-arrow hero-slider-1-arrow"></div>
		</section>

		<!-----------------------------------------------main slider section ends  -------------------------------------------------------->



		<!-- ---------------------------------------------------------Product Listing Section Starts ------------------------------------------------->
		<section class="product-tabs section-padding position-relative wow fadeIn animated">
			<!--<div class="bg-square"></div>-->
			<div class="container">
				<div class="tab-header" style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
					<a href="/product" class="view-more d-inline-flex align-items-center">View More<i
							class="fi-rs-angle-double-small-right"></i></a>
				</div>
				<!--End nav-tabs-->
				<!----------------------------------- All products Listings ---------------------------------------------------->
				<div class="tab-content wow fadeIn animated" id="myTabContent">
					<div class="tab-pane fade show active" id="tab-one" role="tabpanel" aria-labelledby="tab-one">
						<div class="row product-grid-4">
							<% if(products && products.length> 0) { %>
								<% products.forEach(product=>{ %>
									<div class="col-lg-3 col-md-4 col-12 col-sm-6">
										<div class="product-cart-wrap mb-30">
											<div class="product-img-action-wrap">
												<div class="product-img product-img-zoom" style="position: relative;">
													<a href="/product/<%= product._id %>">
														<img src="/uploads/re-image/<%= product.productImage[0] %>"
															alt="<%= product.productName %>"
															style="width: 100%; height: auto;">
														<img class="hover-img"
															src="/uploads/re-image/<%= product.productImage[0] %>"
															alt="<%= product.productName %>"
															style="width: 100%; height: auto;">
													</a>

													<!------------ Wishlist button --------------->
													<button type="button"
														class="wishlist-btn <%= product.isInWishlist ? 'in-wishlist' : '' %>"
														onclick="toggleWishlist(event, '<%= product._id %>')"
														aria-label="Toggle Wishlist"
														style="position: absolute; top: 10px; right: 10px; background: transparent; border: none; cursor: pointer; padding: 5px; z-index: 10;">
														<svg class="wishlist-icon-outline <%= product.isInWishlist ? 'd-none' : '' %>"
															xmlns="http://www.w3.org/2000/svg" width="24" height="24"
															viewBox="0 0 24 24" fill="none" stroke="#088178"
															stroke-width="2" stroke-linecap="round"
															stroke-linejoin="round">
															<path
																d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
															</path>
														</svg>
														<svg class="wishlist-icon-filled <%= product.isInWishlist ? '' : 'd-none' %>"
															xmlns="http://www.w3.org/2000/svg" width="24" height="24"
															viewBox="0 0 24 24" fill="#088178" stroke="#088178"
															stroke-width="2" stroke-linecap="round"
															stroke-linejoin="round">
															<path
																d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
															</path>
														</svg>
													</button>
													<!------------wishlist button ends------------>
												</div>
											</div>
											<div class="product-content-wrap" style="padding: 15px;">
												<div class="product-category">
													<a href="" style="color: #666; font-size: 14px;">
														<% product.Category %>
													</a>
												</div>
												<h2 class="text-center"
													style="margin: 10px 0; font-size: 16px; font-weight: 600;">
													<a href="" style="color: #333; text-decoration: none;">
														<%= product.productName %>
													</a>
												</h2>

												<div class="price-section">
													<div class="price-row text-center">
														<% if (product.hasOffer) { %>
															<span class="original-price "
																style="text-decoration: line-through;">₹<%=
																	product.basePrice.toFixed(2) %></span>
															<span class="final-price">₹<%= product.finalPrice.toFixed(2)
																	%></span>
															<% } else { %>
																<span class="final-price">₹<%=
																		product.basePrice.toFixed(2) %></span>
																<% } %>
													</div>

													<% if (product.hasOffer && product.offer) { %>
														<div class="offers-applied text-center">

															<span class="badge bg-success">
																<%= product.discountPercentage %>% off
															</span>


														</div>
														<% } %>
												</div>

												<div class="stock-info text-center">
													<% if (product.quantity> 0) { %>
														Stock left: <%= product.quantity %>
															<% } else { %>
																<span class="out-of-stock" style=" color:red;">Out of
																	stock</span>
																<% } %>
												</div>
												<!-- Add to Cart section  -->
												<div class="button-container text-center">
													<form id="addToCartForm" data-product-id="<%= product._id %>"
														data-quantity="1">
														<% if (product.isInCart) { %>
															<a href="/cart"
																class="btn btn-sm font-sm rounded btn-brand">
																<i class="material-icons md-shopping_cart"></i>
																Go to Cart
															</a>
															<% } else { %>
																<button type="submit"
																	class="btn  font-sm rounded btn-brand addToCartBtn mt-2"
																	<%=product.quantity===0 ? 'disabled' : '' %>>
																	<i class="material-icons md-add_shopping_cart"></i>
																	Add to Cart
																</button>
																<% } %>
													</form>
												</div>

												<!-- add to cart ends-->
											</div>
										</div>
									</div>
									<% }) %>
										<% } else { %>
											<div class="col-12">
												<p>No products available.</p>
											</div>
											<% } %>
						</div>
					</div>
				</div>
			</div><!--end container-->
			<!--End tab-content-->
			</div>
		</section>

		<!-- ---------------------------------------------------------Product Listing Section Ends ------------------------------------------------->


	</main>


	<!----------------------------add to cart-------------------------->
	<script>
		// Wait for the DOM to be fully loaded
		document.addEventListener('DOMContentLoaded', function () {
			// Get all forms with the ID 'addToCartForm'
			const forms = document.querySelectorAll('form[id^="addToCartForm"]');

			forms.forEach(form => {
				form.addEventListener('submit', async function (event) {
					event.preventDefault(); // Prevent form from submitting the traditional way

					const productId = this.getAttribute('data-product-id');
					const quantity = this.getAttribute('data-quantity') || 1;
					try {
						// Disable the submit button to prevent double submission
						const submitButton = this.querySelector('button[type="submit"]');
						if (submitButton) {
							submitButton.disabled = true;
						}
						// Call the addToCart function to handle the logic
						await addToCart(productId, quantity);

						// Re-enable the submit button
						if (submitButton) {
							submitButton.disabled = false;
						}
					} catch (error) {
						console.error('Form submission error:', error);
						// Re-enable the submit button on error
						const submitButton = this.querySelector('button[type="submit"]');
						if (submitButton) {
							submitButton.disabled = false;
						}
					}

				});
			});
		});

		async function addToCart(productId, quantity) {
			try {
				const response = await fetch('/addToCart', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ productId, quantity: parseInt(quantity) }),

					redirect: 'follow'
				})
				// If we got redirected to login page
				if (response.url.includes('/login')) {
					// Redirect to login page
					window.location.href = '/login';
					return;
				}

				const data = await response.json()
				if (data.redirect) {
					// If server indicates redirect is needed, redirect to login
					window.location.href = data.redirect;
					return;
				}
				if (!response.ok) {
					throw new Error(data.error || 'Failed to add to cart');
				}

				if (data.success) {
					await Swal.fire({
						icon: 'success',
						title: 'Product added to cart',
						text: 'Item successfully added to your cart!',
						confirmButtonText: 'OK',
						showCancelButton: true,
						cancelButtonText: 'Continue Shopping',
						confirmButtonText: 'View Cart'
					});

					// Update cart count and subtotal if available
					//updateCartUI(data.cart);

					// If user clicks "View Cart", redirect to cart page
					if (result.isConfirmed) {
						window.location.href = '/cart';
					}
				} else {
					console.log('error while adding to cart', data.error)
					throw new Error(data.error || 'Failed to add to cart');
				}
			} catch (error) {
				console.error('Add to cart error:', error);
				// If not logged in, redirect to login page
				if (error.message && error.message.includes('<!DOCTYPE html>')) {
					window.location.href = '/login';
					return;
				}
				await Swal.fire({
					icon: 'error',
					title: 'Unable to add to cart',
					text: 'Please log in to add items to your cart',
					confirmButtonText: 'Go to Login',
					showCancelButton: true,
					cancelButtonText: 'Stay Here'
				}).then((result) => {
					if (result.isConfirmed) {
						window.location.href = '/login';
					}
				})
			}
		}


	</script>

	<script>
		function toggleWishlist(event, productId) {
			event.preventDefault();
			const button = event.currentTarget;
			const outlineIcon = button.querySelector('.wishlist-icon-outline');
			const filledIcon = button.querySelector('.wishlist-icon-filled');
			fetch(`/toggleWishlist/${productId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
			})
				.then(response => response.json())
				.then(data => {
					if (data.redirect) {
						// If server indicates redirect is needed, redirect to login
						window.location.href = data.redirect;
						return;
					}
					if (data.success) {
						// Toggle visibility of icons
						outlineIcon.classList.toggle('d-none');
						filledIcon.classList.toggle('d-none');
						button.classList.toggle('in-wishlist');
						button.classList.add('animate');

						// Remove animation class after animation completes
						setTimeout(() => {
							button.classList.remove('animate');
						}, 300);

					
						// Update the wishlist count in header
						updateWishlistCount(data.wishlistCount);

						
					}
					
				})
				.catch(error => {
					console.error('Error:', error);
					Swal.fire({
						icon: 'error',
						title: 'Oops...',
						text: 'An error occurred while updating wishlist',
						confirmButtonText: 'OK'
					});
				});
			return false;
		}

		// function to update the wishlist count in header
		function updateWishlistCount(count) {
			const wishlistCountElement = document.getElementById('wishlist-count');
			if (wishlistCountElement) {
				wishlistCountElement.textContent = count;

				// Add animation to highlight the count change
				wishlistCountElement.classList.add('count-updated');
				setTimeout(() => {
					wishlistCountElement.classList.remove('count-updated');
				}, 300);
			}
		}
	</script>
	<!----------------------------add to cart end-------------------------->

	<%- include('../partials/user/footer.ejs') %>