<%- include('../partials/admin/sidebar.ejs') %>
    <%- include('../partials/admin/header.ejs') %>


        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            body {
                background-color: #f8f9fa;
            }

            .offer-form {
                background-color: #ffffff;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }

            .table {
                background-color: #ffffff;
            }

            .btn-add {
                margin-bottom: 20px;
            }
        </style>

        <div class="container mt-5">
            <h1 class="text-center mb-4">Manage Offers</h1>
            <button id="showAddForm" class="btn btn-primary btn-add">Add New Offer</button>

            <div id="offerForm" class="offer-form p-4 mb-4" style="display: none;">
                <h2 id="formTitle" class="mb-3">Add New Offer</h2>
                <form>
                    <input type="hidden" id="offerId">
                    <div class="mb-3">
                        <label for="type" class="form-label">Offer Type:</label>
                        <select id="type" class="form-select" required>
                            <option value="product">Product Offer</option>
                            <option value="category">Category Offer</option>
                            <option value="referral">Referral Offer</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="title" class="form-label">Title:</label>
                        <input type="text" id="title" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description:</label>
                        <textarea id="description" class="form-control"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="discountPercentage" class="form-label">Discount Percentage:</label>
                        <input type="number" id="discountPercentage" class="form-control" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="validFrom" class="form-label">Valid From:</label>
                            <input type="date" id="validFrom" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="validTo" class="form-label">Valid To:</label>
                            <input type="date" id="validTo" class="form-control" required>
                        </div>
                    </div>

                    <div id="productField" class="mb-3" style="display: none;">
                        <label for="productId" class="form-label">Product ID:</label>
                        <input type="text" id="productId" class="form-control">
                    </div>

                    <div id="categoryField" class="mb-3" style="display: none;">
                        <label for="categoryId" class="form-label">Category:</label>
                        <select id="categoryId" class="form-select">
                            <option value="">Select a category</option>
                            <% JSON.parse(categories).forEach(category=> { %>
                                <option value="<%= category._id %>">
                                    <%= category.name %>
                                </option>
                                <% }) %>
                        </select>
                    </div>

                    <div id="referralField" class="mb-3" style="display: none;">
                        <label for="referralCode" class="form-label">Referral Code:</label>
                        <input type="text" id="referralCode" class="form-control">
                    </div>

                    <button type="submit" class="btn btn-success">Save Offer</button>
                    <button type="button" id="cancelEdit" class="btn btn-secondary">Cancel</button>
                </form>
            </div>

            <div class="table-responsive">
                <table id="offersTable" class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Discount</th>
                            <th>Valid From</th>
                            <th>Valid To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <script>


            $(document).ready(function () {
                loadOffers();
            
                $('#showAddForm').click(function () {
                    $('#offerForm').slideDown();
                    $('#offerId').val('');
                    $('#offerForm form')[0].reset();
                    $('#formTitle').text('Add New Offer');
                });

                $('#cancelEdit').click(function () {
                    $('#offerForm').slideUp();
                });

                $('#type').change(function () {
                    $('#productField, #categoryField, #referralField').hide();
                    $('#' + $(this).val() + 'Field').show();
                    if ($(this).val() === 'category') {
                        $('#categoryId').prop('required', true);
                    } else {
                        $('#categoryId').prop('required', false);
                    }
                });

                $('#offerForm form').submit(function (e) {
                    e.preventDefault();
                    const offerId = $('#offerId').val();
                    const offerData = {
                        type: $('#type').val(),
                        title: $('#title').val(),
                        description: $('#description').val(),
                        discountPercentage: $('#discountPercentage').val(),
                        validFrom: $('#validFrom').val(),
                        validTo: $('#validTo').val(),
                        productId: $('#productId').val()||null,
                        categoryId: $('#categoryId').val(),
                        referralCode: $('#referralCode').val()
                    };
                    console.log('Submitting offer data:', offerData);

                    if (offerId) {
                        updateOffer(offerId, offerData);
                    } else {
                        addOffer(offerData);
                    }
                });

                function addOffer(offerData) {
                    $.ajax({
                        url: '/admin/api/offers',
                        type: 'POST',
                        data: offerData,
                        success: function (response) {
                            console.log('Offer added successfully:', response);
                            loadOffers();
                            $('#offerForm').slideUp();
                        },
                        error: function (xhr, status, error) {
                            console.error('Error adding offer:', error);
                            alert('Failed to add offer. Please try again.');
                        }
                    });
                }

                function updateOffer(id, offerData) {
                    $.ajax({
                        url: `/admin/api/offers/${id}`,
                        type: 'PUT',
                        data: offerData,
                        success: function (response) {
                            console.log('Offer updated successfully:', response);
                            loadOffers();
                            $('#offerForm').slideUp();
                        },
                        error: function (xhr, status, error) {
                            console.error('Error updating offer:', error);
                            alert('Failed to update offer. Please try again.');
                        }
                    });
                }

                function loadOffers() {
                    $.ajax({
                        url: '/admin/api/offers',
                        type: 'GET',
                        success: function (offers) {
                            console.log('Offers loaded successfully:', offers);
                            const tbody = $('#offersTable tbody');
                            tbody.empty();
                            offers.forEach(function (offer) {
                                tbody.append(`
                    <tr>
                        <td>${offer.type}</td>
                        <td>${offer.title}</td>
                        <td>${offer.discountPercentage}%</td>
                        <td>${new Date(offer.validFrom).toLocaleDateString()}</td>
                        <td>${new Date(offer.validTo).toLocaleDateString()}</td>
                        <td>
                            <button onclick="editOffer('${offer._id}')" class="btn btn-sm btn-warning">Edit</button>
                            <button onclick="deleteOffer('${offer._id}')" class="btn btn-sm btn-danger">Delete</button>
                        </td>
                    </tr>
                `);
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error('Error loading offers:', error);
                            alert('Failed to load offers. Please refresh the page.');
                        }
                    } )
                
             }
                    
                    
                    
                    
                    window.editOffer = function (id) {
                        $.get(`/admin/api/offers/${id}`, function (offer) {
                            $('#offerId').val(offer._id);
                            $('#type').val(offer.type).trigger('change');
                            $('#title').val(offer.title);
                            $('#description').val(offer.description);
                            $('#discountPercentage').val(offer.discountPercentage);
                            $('#validFrom').val(offer.validFrom.split('T')[0]);
                            $('#validTo').val(offer.validTo.split('T')[0]);
                            $('#productId').val(offer.productId);
                            $('#categoryId').val(offer.categoryId);
                            $('#referralCode').val(offer.referralCode);
                            $('#offerForm').slideDown();
                            $('#formTitle').text('Edit Offer');
                        });
                    }

                    window.deleteOffer = function (id) {
                            if (confirm('Are you sure you want to delete this offer?')) {
                                $.ajax({
                                    url: `/admin/api/offers/${id}`,
                                    type: 'DELETE',
                                    success: function () {
                                        loadOffers();
                                    }
                                });
                            }
                        }
                });
        </script>